#
# Tests templating functionality
#
import fccodegen as cg
import logging
import os
import re


# Show more logging output
logging.getLogger().setLevel(logging.INFO)


def test_generate_weblab_model(tmp_path):
    # Tests the create_weblab_model() method

    # Load cellml model
    model = os.path.join(
        cg.DIR_DATA, 'tests',
        'hodgkin_huxley_squid_axon_model_1952_modified.cellml'
    )
    model = cg.load_model(model)

    # Select output path (in temporary dir)
    path = tmp_path / 'model.pyx'

    # Create weblab model at path
    cg.create_weblab_model(model, path)

    # Read expected output from file
    expected = os.path.join(cg.DIR_DATA, 'tests', 'weblab_model.pyx')
    with open(expected, 'r') as f:
        expected = f.read()

    # Read generated output from file
    generated = path.read_text()
    #print(generated)

    # Remove line about creation date and version
    p = re.compile('# Generated by .+')
    expected = p.sub('# Generated by me', expected).strip()
    generated = p.sub('# Generated by me', generated).strip()

    # Now they should match
    assert generated == expected
